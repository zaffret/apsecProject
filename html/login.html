const togglePassword = document.querySelector("#togglePassword");
const password = document.querySelector("#psw");

togglePassword.addEventListener("click", function () {
  const type = password.getAttribute("type") === "password" ? "text" : "password";
  password.setAttribute("type", type);
  this.querySelector("i").classList.toggle("bi-eye");
  this.querySelector("i").classList.toggle("bi-eye-slash");
});

const passwordValidation = document.getElementById("passwordCheck");

const validationRules = [
  {
    element: document.getElementById("minLength"),
    test: (value) => value.length >= 8,
  },
  {
    element: document.getElementById("lowercase"),
    test: (value) => /[a-z]/.test(value),
  },
  {
    element: document.getElementById("uppercase"),
    test: (value) => /[A-Z]/.test(value),
  },
  {
    element: document.getElementById("number"),
    test: (value) => /\d/.test(value),
  },
  {
    element: document.getElementById("specialChar"),
    test: (value) => /[^A-Za-z0-9]/.test(value),
  },
  {
    element: document.getElementById("noSpaces"),
    test: (value) => !/\s/.test(value),
  },
];

function validatePassword() {
  const pswValue = password.value;

  validationRules.forEach((rule) => {
    if (rule.test(pswValue)) {
      rule.element.classList.add("valid");
      rule.element.classList.remove("invalid");
    } else {
      rule.element.classList.add("invalid");
      rule.element.classList.remove("valid");
    }
  });
}

password.addEventListener("input", function () {
  passwordValidation.style.display = "block";
  if (!password.value) {
    passwordValidation.style.display = "none";
  }
  validatePassword();
});

let lockoutInterval;

function showModal(lockoutEndTime) {
  document.getElementById("lockoutModal").style.display = "block";
  const lockoutTimeElement = document.getElementById("lockoutTime");
  const currentTime = new Date().getTime();
  let timeRemaining = lockoutEndTime - currentTime;

  function updateLockoutTime() {
    if (timeRemaining <= 0) {
      clearInterval(lockoutInterval);
      hideModal();
      localStorage.removeItem("lockoutEndTime"); // Remove lockout end time from local storage
    } else {
      timeRemaining -= 999;
      const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
      let minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
      if (seconds < 0) {
        seconds = 0;
      }
      lockoutTimeElement.textContent = `${minutes} minute${minutes !== 1 ? "s" : ""} and ${seconds} second${seconds !== 1 ? "s" : ""}`;
    }
  }

  updateLockoutTime();
  lockoutInterval = setInterval(updateLockoutTime, 1000);
}

function hideModal() {
  clearInterval(lockoutInterval);
  document.getElementById("lockoutModal").style.display = "none";
}

async function processForm(event) {
  event.preventDefault();

  const uname = document.getElementById("uname");
  const psw = document.getElementById("psw");
  const role = document.getElementById("role").value;
  const recaptchaResponse = grecaptcha.getResponse();

  const verifyCaptcha = await fetch("/verify-captcha", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      recaptchaResponse,
    }),
  });
  const captchaResponse = await verifyCaptcha.json();

  if (!captchaResponse.success) {
    document.getElementById("error").innerText = "reCAPTCHA verification failed. Please try again.";
    grecaptcha.reset();
    return;
  }

  const data = JSON.stringify({
    name: uname.value,
    password: psw.value,
  });

  const xhr = new XMLHttpRequest();

  xhr.addEventListener("readystatechange", function () {
    if (this.readyState === 4) {
      const response = JSON.parse(this.responseText);
      if (this.status === 200) {
        localStorage.setItem("token", response.token);
        localStorage.setItem("role", role);
        localStorage.setItem("uname", uname.value);

        if (response.role == "member") {
          window.location.href = "member.html";
        } else if (response.role == "admin") {
          window.location.href = "admin.html";
        } else if (response.role == "creator") {
          window.location.href = "creator.html";
        } else {
          window.location.href = "user.html";
        }
      } else if (this.status === 423) {
        const lockoutEndTime = new Date(response.lockoutEndTime).getTime();
        localStorage.setItem("lockoutEndTime", lockoutEndTime); // Save lockout end time to local storage
        showModal(lockoutEndTime);
      }
      const errorSpan = document.getElementById("error");
      errorSpan.innerText = response.message;
    }
  });

  xhr.open("POST", "https://thuhtet.com/" + role + "-login");
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.send(data);
}

const form = document.getElementById("loginForm");
form.addEventListener("submit", processForm);

const inputs = document.querySelectorAll(".form-control");
inputs.forEach((input) => {
  input.addEventListener("focus", function () {
    const errorSpan = document.getElementById("error");
    errorSpan.innerText = "";
  });
});


window.addEventListener("load", function () {
  const lockoutEndTime = localStorage.getItem("lockoutEndTime");
  if (lockoutEndTime) {
    const currentTime = new Date().getTime();
    if (currentTime < lockoutEndTime) {
      showModal(lockoutEndTime);
    } else {
      localStorage.removeItem("lockoutEndTime");
    }
  }
});
